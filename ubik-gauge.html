<link rel="import" href="../polymer/polymer.html">

<dom-module id="ubik-gauge">

  <template>
    <style>
      :host {
        display: flex;
        box-sizing: border-box;
        justify-content: center;
      }
      label {
        color : var(--ubik-gauge-label-color)
      }
    </style>
    <div style="flex: 1;">
      <svg id="chart" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
        <text text-anchor="middle" x="52" y="58" style="font : 0.5em sans-serif;">
          [[value]]
          <tspan style="font: 0.5em sans-serif;">[[unit]]</tspan>
        </text>
      </svg>
      <label>[[label]]</label>
    </div>
  </template>

  <script>
  (function() {
    'use strict';

    Polymer({

      is: 'ubik-gauge',

      properties: {

        label: {
          type: String,
          value: '',
          notify: true
        },

        value: {
          type: String,
          value: '50.0',
          notify: true,
          observer : ['valueChanged']
        },

        unit: {
          type: String,
          value: '%'
        },

        treshold: {
          type: Number,
          value: 80,
          notify: true,
          observer : ['tresholdChanged']
        },

        semicircle: {
          type: Boolean,
          value: false
        },

        colors: {
          type: Array,
          value: function () { return ['#F00','#FAA','#EEE']},
          notify: true
        }
      },

      ready : function () {
        var radius = 50-(5/2);
        this._createArc(100,5,radius, this.colors[2]);
        this._tresholdArc = this._createArc(this.treshold, 5, radius, this.colors[1]);
        this._valueArc    = this._createArc(this.value,    5, radius, this.colors[0]);
      },

      // Observers

      valueChanged : function (newValue, oldValue) {
        this._resizeArc(this._valueArc, newValue);
      },

      tresholdChanged : function (newValue, oldValue) {
        this._resizeArc(this._valueArc, newValue);
      },

      // Internal

      _valueArc : null,
      _tresholdArc : null,

      _createArc : function (percentage, width, rad1, color) {
          var path = this._newPath(percentage, rad1, width, color);
          this.$.chart.appendChild(path);
          return path;
      },

      _resizeArc: function (arc, percentage) {
        var radius = 50-(5/2);
        if (arc)
          path.setAttribute("d", this._calculateArc(percentage, radius));
      },

      _newPath : function (percentage, radius, width, color) {
        var svgns = "http://www.w3.org/2000/svg";
        var path = document.createElementNS(svgns, "path");
        path.setAttribute("d", this._calculatePath(percentage, radius));
        path.setAttribute("fill", 'none');
        path.setAttribute("stroke", color);
        path.setAttribute("stroke-width", width);
        path.setAttribute("stroke-linecap", "round");
        return path;
      },

      _calculatePath : function(percentage, rad1) {

        var unit = (Math.PI *2) / 100;
        var angle = (percentage * unit - 0.001);
        var large_arc_flag = percentage > 50 ? 1 : 0;

        if (this.semicircle) {
            angle = angle / 2;
            large_arc_flag = 0;
        }

        var x1 = 50 - rad1;
        var x2 = 50 - rad1 * Math.cos(angle);
        var y2 = 50 - rad1 * Math.sin(angle);

        var d = " M " + x1   + ", 50 " + " A " + rad1 + "," + rad1 + " 0 " + large_arc_flag + " 1 " + x2 + "," + y2;

        return d;
      }

    });
  })();
  </script>
</dom-module>
